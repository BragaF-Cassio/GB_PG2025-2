# Precisa instalar o OpenCV e Dear PyGui antes de rodar este código:
# pip install opencv-python dearpygui

import dearpygui.dearpygui as dpg
import cv2 as cv
import numpy as np
from enum import Enum

software_mode = "camera"  # "image" or "camera"

effects_array = []

class Effects(Enum):
    BLUR = 0
    GRAYSCALE = 1
    EDGE_DETECTION = 2

class Efeitos():
    def __init__(self, effect_type: Effects, tagname: str):
        self.effect_type = effect_type
        self.tagname = tagname

def change_mode_callback():
    global software_mode
    dpg_value = dpg.get_value("image_camera_checkbox")
    if dpg_value:
        software_mode = "camera"
        width = 640
        height = 480
        dpg.configure_item("opencv_image", width=width, height=height)
    else:
        software_mode = "image"
        height, width, channels = cv_image.shape
        dpg.configure_item("opencv_image", width=width, height=height)
        update_texture()

def update_video_frame():
    if software_mode != "camera":
        return

    ret, frame = capture.read()
    if ret:
        # Convert BGR frame to RGB (DPG expects RGB)
        frame_rgb = cv.cvtColor(frame, cv.COLOR_BGR2RGBA)
        
        frame_rgb = process_effects(frame_rgb, effects_array)

        # Normalize pixel values from [0, 255] to [0.0, 1.0]
        frame_normalized = frame_rgb.flatten() / 255.0

        # Update the dynamic texture with the new frame data
        dpg.set_value("opencv_image", frame_normalized)

def save_callback():
    print("Save Clicked")

def process_effects(image, effects_list):
    for effect in effects_list:
        value = dpg.get_value(effect.tagname)

        if effect.effect_type == Effects.GRAYSCALE:
            if value:
                image = cv.cvtColor(image, cv.COLOR_RGBA2GRAY)
                image = cv.cvtColor(image, cv.COLOR_GRAY2RGBA)
        elif effect.effect_type == Effects.BLUR:
            value = int(value)
            if value % 2 == 0:
                value += 1
            image = cv.GaussianBlur(image, (value, value), 0)
        elif effect.effect_type == Effects.EDGE_DETECTION:
            if value:
                gray = cv.cvtColor(image, cv.COLOR_RGBA2GRAY)
                edges = cv.Canny(gray, 100, 200)
                image = cv.cvtColor(edges, cv.COLOR_GRAY2RGBA)

    return image

def update_texture():
    if software_mode == "image":
        modified_image = cv_image.copy()
        modified_image = process_effects(modified_image, effects_array)
        dpg.set_value("opencv_image", modified_image.flatten() / 255.0)
        return

effects_array.append(Efeitos(Effects.GRAYSCALE, "gray_scale_checkbox"))
effects_array.append(Efeitos(Effects.BLUR, "blur_slider"))

# Load an OpenCV image
image_path = "res/colored_pencils_colour_pencils.jpg"
cv_original_image = cv.imread(image_path)
cv_image = cv_original_image.copy()
cv_image = cv.cvtColor(cv_image, cv.COLOR_BGR2RGBA)  # Convert to RGBA format

# Get image dimensions
height, width, channels = cv_image.shape
width = 640
height = 480

# Flatten the image array for Dear PyGui
image_data = cv_image.flatten() / 255.0  # Normalize pixel values to [0, 1]

capture = cv.VideoCapture(0)
if not capture.isOpened():
    print("Cannot open camera or video file")
    exit()
# Define dimensões de captura
capture.set(cv.CAP_PROP_FRAME_WIDTH, width)
capture.set(cv.CAP_PROP_FRAME_HEIGHT, height)

# Create Dear PyGui context
dpg.create_context()
dpg.create_viewport()
dpg.setup_dearpygui()

# Create a dynamic texture for the OpenCV image
with dpg.texture_registry(show=False):
    dpg.add_dynamic_texture(width, height, image_data, tag="opencv_image")


# Create the main window
with dpg.window(label="Janela de Exemplo",no_close=True,no_resize=True,no_collapse=True):
    dpg.add_checkbox(label="Imagem / Câmera", tag="image_camera_checkbox", callback=change_mode_callback, default_value=True)
    dpg.add_combo(label="Seletor de efeitos", items=["Opção 1", "Opção 2", "Opção 3"], default_value="Opção 1")
    dpg.add_text("Massa demais")
    dpg.add_button(label="Atualiza Textura", callback=update_texture)  # Button to update texture
    dpg.add_input_text(label="texto aqui")
    dpg.add_checkbox(label="Escala de Cinza", tag="gray_scale_checkbox", callback=update_texture)
    #dpg.add_slider_float(label="Escala de Cinza", tag="gray_scale", min_value=0.0, max_value=1.0)
    dpg.add_slider_int(label="Nível de Blur", min_value=0, max_value=30, default_value=1, tag="blur_slider", callback=update_texture)
    dpg.add_image("opencv_image")  # Add the OpenCV image as a texture

# Stretch the viewport to fit the content
dpg.set_viewport_width(width + 50)  # Add some padding
dpg.set_viewport_height(height + 200)  # Add some padding for other widgets

dpg.show_viewport()

# dpg.start_dearpygui()
# dpg.destroy_context()
try:
    while dpg.is_dearpygui_running():
        update_video_frame()
        dpg.render_dearpygui_frame()
except SystemExit:
    # Handle the application closing (e.g., hitting the 'X' button)
    pass
finally:
    # Release the OpenCV capture and destroy context
    capture.release()
    dpg.destroy_context()

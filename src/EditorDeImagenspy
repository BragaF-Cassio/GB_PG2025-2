# Precisa instalar o OpenCV e Dear PyGui antes de rodar este código:
# pip install opencv-python dearpygui

import dearpygui.dearpygui as dpg
import cv2 as cv
import numpy as np

def save_callback():
    print("Save Clicked")

def update_texture():
    blur_level = int(dpg.get_value("blur_slider"))  # Convert to integer (kernel size must be odd)
    if blur_level % 2 == 0:  # Ensure the kernel size is odd
        blur_level += 1

    gray_scale = dpg.get_value("gray_scale_checkbox")

    modified_image = cv_image.copy()

    if gray_scale:
        modified_image = cv.cvtColor(modified_image, cv.COLOR_RGBA2GRAY)
        modified_image = cv.cvtColor(modified_image, cv.COLOR_GRAY2RGBA)

    # Modify the image dynamically (e.g., apply a blur effect)
    modified_image = cv.GaussianBlur(modified_image, (blur_level, blur_level), 0)

    dpg.set_value("opencv_image", modified_image.flatten() / 255.0)  # Update texture data

# Load an OpenCV image
image_path = "res/colored_pencils_colour_pencils.jpg"
cv_original_image = cv.imread(image_path)
cv_image = cv_original_image.copy()
cv_image = cv.cvtColor(cv_image, cv.COLOR_BGR2RGBA)  # Convert to RGBA format

# Get image dimensions
height, width, channels = cv_image.shape

# Flatten the image array for Dear PyGui
image_data = cv_image.flatten() / 255.0  # Normalize pixel values to [0, 1]

# Create Dear PyGui context
dpg.create_context()
dpg.create_viewport()
dpg.setup_dearpygui()

# Create a dynamic texture for the OpenCV image
with dpg.texture_registry():
    dpg.add_dynamic_texture(width, height, image_data, tag="opencv_image")


# Create the main window
with dpg.window(label="Janela de Exemplo",no_close=True,no_resize=True,no_collapse=True):
    dpg.add_text("Massa demais")
    dpg.add_button(label="Atualiza Textura", callback=update_texture)  # Button to update texture
    dpg.add_input_text(label="texto aqui")
    dpg.add_checkbox(label="Escala de Cinza", tag="gray_scale_checkbox", callback=update_texture)
    #dpg.add_slider_float(label="Escala de Cinza", tag="gray_scale", min_value=0.0, max_value=1.0)
    dpg.add_slider_int(label="Nível de Blur", min_value=1, max_value=30, default_value=1, tag="blur_slider", callback=update_texture)
    dpg.add_image("opencv_image")  # Add the OpenCV image as a texture

# Stretch the viewport to fit the content
dpg.set_viewport_width(width + 50)  # Add some padding
dpg.set_viewport_height(height + 200)  # Add some padding for other widgets

# Show the viewport and start Dear PyGui
dpg.show_viewport()
dpg.start_dearpygui()
dpg.destroy_context()